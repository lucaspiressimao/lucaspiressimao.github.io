<!DOCTYPE html>
<html>
	<head>
		<style>
			#campoJogo{
			    width: 300px;
			    height: 600px;
			    
			    top: 0;
			    bottom: 0;
			    left: 0;
			    right: 0;
			    margin: auto;
			    outline: 1px solid;
			}
			.campo{
			    width: 30px;
			    height: 30px;
			    
			    float: left;
			}
			.peca{
				box-shadow: 1px 1px;
			}
		</style>
	</head>	
	<body>
		acrescentar outros tipos de pe√ßas <br>
		remover linhas completas<br>
		contar pontos<br>
		verificar fim de jogo <br>
		<div id='campoJogo'></div>
	</body>
</html>
<script type="text/javascript" >
		
	//(function() {
		var linhas = 20;
		var colunas = 10;
		var direcao = 'd'; //c = cima / b = baixo / d = direita / e = esquerda
		var speed = 1000;
		var lin = 0
		var col = 0
		var fim = false;
		var pontos = 0;
		var objeto = null;
		var base = [];
		var colisao = false;
		var max_linhas = false;
		var a_, b_, c_, d_ = null;
		var numeroSorte = 0;
		var removerLinhas = []
		var tipos = {
			't': {
				'sentido': 'b',
				'color': 'red',
				'position':  {
					'a': null,
					'c': null,
					'b': null,
					'd': null
				},
				'girar': function() {
					limpar(this);
					var a_col, b_col, c_col, d_col = 0;
					var s = '';
					var a_col = parseInt(this['position'].a.getAttribute("data-coluna"));
					var b_col = parseInt(this['position'].b.getAttribute("data-coluna"));
					var c_col = parseInt(this['position'].c.getAttribute("data-coluna"));
					var d_col = parseInt(this['position'].d.getAttribute("data-coluna"));

					var b_lin = parseInt(this['position'].b.getAttribute("data-linha"));
				
					switch(this['sentido']){
						case 'b':
							b_lin -= 1;
							s = 'e';
							break;
						case 'e':
							b_col += 1;
							s = 'c';
							break;
						case 'c':
							b_lin += 1;
							s = 'd';
							break;
						case 'd':
							b_col -= 1;
							s = 'b';
							break;
					}

					if(b_col < colunas && b_col >= 0 && b_lin < linhas && !verificaColisao()){
							this['sentido'] = s;
							this['position'].c = this['position'].d
							this['position'].d = this['position'].a
							this['position'].a = document.querySelector('[data-linha="' + b_lin + '"][data-coluna="' + b_col + '"]');
					}
					this['position'].a.setAttribute('data-cor', this['color']);
					this['position'].b.setAttribute('data-cor', this['color']);
					this['position'].c.setAttribute('data-cor', this['color']);
					this['position'].d.setAttribute('data-cor', this['color']);
					pintar(this);
				},
				'criar': function() {
					this['sentido'] = 'b';
					this['position'].a = document.querySelector('[data-linha="1"][data-coluna="3"]');
					this['position'].b = document.querySelector('[data-linha="1"][data-coluna="4"]');
					this['position'].c = document.querySelector('[data-linha="1"][data-coluna="5"]');
					this['position'].d = document.querySelector('[data-linha="2"][data-coluna="4"]');
					this['position'].a.setAttribute('data-cor', this['color']);
					this['position'].b.setAttribute('data-cor', this['color']);
					this['position'].c.setAttribute('data-cor', this['color']);
					this['position'].d.setAttribute('data-cor', this['color']);
					pintar(this);
				}
			},
			'i': {
				'sentido': 'b',
				'color': 'blue',
				'position':  {
					'a': null,
					'c': null,
					'b': null,
					'd': null
				},
				'girar': function() {
					limpar(this);
					var s = '';
					var a_col, b_col, d_col = 0;
					var a_lin, b_lin, d_lin = 0;

					a_col = parseInt(this['position'].a.getAttribute("data-coluna"));
					b_col = parseInt(this['position'].b.getAttribute("data-coluna"));
					d_col = parseInt(this['position'].d.getAttribute("data-coluna"));

					a_lin = parseInt(this['position'].a.getAttribute("data-linha"));
					b_lin = parseInt(this['position'].b.getAttribute("data-linha"));
					d_lin = parseInt(this['position'].d.getAttribute("data-linha"));
				
					switch(this['sentido']){
						case 'l':
							a_lin -= 2;
							a_col += 2;
							b_lin -= 1;
							b_col += 1;
							d_lin += 1;
							d_col -= 1;
							s = 'b';
							break;
						case 'b':
							a_lin += 2;
							a_col -= 2;
							b_lin += 1;
							b_col -= 1;
							d_lin -= 1;
							d_col += 1;
							s = 'l';
							break;
					}

					if( (Math.min(a_lin, b_lin, d_lin) >= 0) && 
						(Math.max(a_lin, b_lin, d_lin) < linhas) && 
						(Math.min(a_col, b_col, d_col) >= 0) && 
						(Math.max(a_col, b_col, d_col) < colunas) &&
						!verificaColisao()){
							this['sentido'] = s;
							this['position'].a = document.querySelector('[data-linha="' + a_lin + '"][data-coluna="' + a_col + '"]');
							this['position'].b = document.querySelector('[data-linha="' + b_lin + '"][data-coluna="' + b_col + '"]');
							this['position'].d = document.querySelector('[data-linha="' + d_lin + '"][data-coluna="' + d_col + '"]');
						}
					this['position'].a.setAttribute('data-cor', this['color']);
					this['position'].b.setAttribute('data-cor', this['color']);
					this['position'].c.setAttribute('data-cor', this['color']);
					this['position'].d.setAttribute('data-cor', this['color']);
					pintar(this);
				},
				'criar': function() {
					this['sentido'] = 'b';
					this['position'].a = document.querySelector('[data-linha="1"][data-coluna="5"]');
					this['position'].b = document.querySelector('[data-linha="2"][data-coluna="5"]');
					this['position'].c = document.querySelector('[data-linha="3"][data-coluna="5"]');
					this['position'].d = document.querySelector('[data-linha="4"][data-coluna="5"]');
					this['position'].a.setAttribute('data-cor', this['color']);
					this['position'].b.setAttribute('data-cor', this['color']);
					this['position'].c.setAttribute('data-cor', this['color']);
					this['position'].d.setAttribute('data-cor', this['color']);
					pintar(this);
				}
			}
		};

		function mover(obj, sentido){
			limpar(obj);
			var a_col = parseInt(obj.position.a.getAttribute("data-coluna"));
			var b_col = parseInt(obj.position.b.getAttribute("data-coluna"));
			var c_col = parseInt(obj.position.c.getAttribute("data-coluna"));
			var d_col = parseInt(obj.position.d.getAttribute("data-coluna"));
			
			var a_cor = obj.position.a.getAttribute("data-cor");
			var b_cor = obj.position.b.getAttribute("data-cor");
			var c_cor = obj.position.c.getAttribute("data-cor");
			var d_cor = obj.position.d.getAttribute("data-cor");

			a_col += sentido;
			b_col += sentido;
			c_col += sentido;
			d_col += sentido;
			
			if( Math.min(a_col, b_col, c_col, d_col) >= 0 && Math.max(a_col, b_col, c_col, d_col) < colunas ){
				obj.position.a = document.querySelector('[data-linha="' + obj.position.a.getAttribute("data-linha") + '"][data-coluna="' + a_col + '"]');
				obj.position.b = document.querySelector('[data-linha="' + obj.position.b.getAttribute("data-linha") + '"][data-coluna="' + b_col + '"]');
				obj.position.c = document.querySelector('[data-linha="' + obj.position.c.getAttribute("data-linha") + '"][data-coluna="' + c_col + '"]');
				obj.position.d = document.querySelector('[data-linha="' + obj.position.d.getAttribute("data-linha") + '"][data-coluna="' + d_col + '"]');

				obj.position.a.setAttribute('data-cor', a_cor);
				obj.position.b.setAttribute('data-cor', b_cor);
				obj.position.c.setAttribute('data-cor', c_cor);
				obj.position.d.setAttribute('data-cor', d_cor);
			}
			pintar(obj);
		}

		function limpar(obj){
			obj.position.a.removeAttribute("style");
			obj.position.b.removeAttribute("style");
			obj.position.c.removeAttribute("style");
			obj.position.d.removeAttribute("style");
		}

		function pintar(obj){
			obj.position.a.style.backgroundColor = obj.color;
			obj.position.b.style.backgroundColor = obj.color;
			obj.position.c.style.backgroundColor = obj.color;
			obj.position.d.style.backgroundColor = obj.color;
			obj.position.a.style.boxShadow = "inset 0px 0px 2px 2px rgba(0,0,0,0.5)";
			obj.position.b.style.boxShadow = "inset 0px 0px 2px 2px rgba(0,0,0,0.5)";
			obj.position.c.style.boxShadow = "inset 0px 0px 2px 2px rgba(0,0,0,0.5)";
			obj.position.d.style.boxShadow = "inset 0px 0px 2px 2px rgba(0,0,0,0.5)";
		}

		function criarCampo(){
			for (i = 0; i < linhas; i++) { 
				var divLinha = document.createElement('div');
				divLinha.setAttribute('id', 'linha' + i);
				document.getElementById("campoJogo").appendChild(divLinha);
				for (j = 0; j < colunas; j++) { 
					var div = document.createElement('div');
					div.className = 'campo';
					div.setAttribute('data-linha', i);
					div.setAttribute('data-coluna', j);
					div.setAttribute('data-cor', 'white');
					document.getElementById("linha"+i).appendChild(div);
				}
			}
		}

		function gerarObjeto(){
			if(objeto == null){
				numeroSorte = (Math.floor((Math.random() * 10)) % (Object.values(tipos).length) );
				objeto = Object.values(tipos)[numeroSorte];
				objeto.criar();
			}
		}

		function verificaColisao(lateral=false, direcao=0, descer=1){
			colisao = false;
			a_, b_, c_, d_ = null;
			if( objeto !== null){
				var a_lin = parseInt(objeto.position.a.getAttribute("data-linha"));
				var b_lin = parseInt(objeto.position.b.getAttribute("data-linha"));
				var c_lin = parseInt(objeto.position.c.getAttribute("data-linha"));
				var d_lin = parseInt(objeto.position.d.getAttribute("data-linha"));
				
				var a_col = parseInt(objeto.position.a.getAttribute("data-coluna"));
				var b_col = parseInt(objeto.position.b.getAttribute("data-coluna"));
				var c_col = parseInt(objeto.position.c.getAttribute("data-coluna"));
				var d_col = parseInt(objeto.position.d.getAttribute("data-coluna"));
		
				if(lateral)
					descer = 0;
				
				a_ = document.querySelector('[data-linha="' + (a_lin + descer) + '"][data-coluna="' + (a_col + direcao) + '"]');
				b_ = document.querySelector('[data-linha="' + (b_lin + descer) + '"][data-coluna="' + (b_col + direcao) + '"]');
				c_ = document.querySelector('[data-linha="' + (c_lin + descer) + '"][data-coluna="' + (c_col + direcao) + '"]');
				d_ = document.querySelector('[data-linha="' + (d_lin + descer) + '"][data-coluna="' + (d_col + direcao) + '"]');
			
				for (var i = 0; i < base.length; i++) {
					if (base[i].isEqualNode(a_) ||
						base[i].isEqualNode(b_) ||
						base[i].isEqualNode(c_) ||
						base[i].isEqualNode(d_)){
						colisao = true;
						break;
					}
				}

				max_linhas = (Math.max(a_lin, b_lin, c_lin, d_lin) +1) < linhas
				return colisao;
			}
		}

		function descerObjeto(){
			if( objeto !== null){

				limpar(objeto);
				verificaColisao();
				
				if( max_linhas && !colisao){
					a_.setAttribute('data-cor', objeto.position.a.getAttribute('data-cor'));
					b_.setAttribute('data-cor', objeto.position.b.getAttribute('data-cor'));
					c_.setAttribute('data-cor', objeto.position.c.getAttribute('data-cor'));
					d_.setAttribute('data-cor', objeto.position.d.getAttribute('data-cor'));
					objeto.position.a = a_;
					objeto.position.b = b_;
					objeto.position.c = c_;
					objeto.position.d = d_;
					pintar(objeto);
				} else {	
					atualizarBase();
				}	

			}
		}

		function pintarBase(){
			for (var i = 0; i < base.length; i++) {
				base[i].style.backgroundColor = base[i].getAttribute("data-cor");
				base[i].style.boxShadow = "inset 0px 0px 2px 2px rgba(0,0,0,0.5)";
			}
		}

		function atualizarBase(){
			base.push(objeto.position.a);
			base.push(objeto.position.b);
			base.push(objeto.position.c);
			base.push(objeto.position.d);
			objeto = null;
		}

		function removeLinhas(){
			for (var i = 0; i < linhas; i++) {
				removerLinhas[i] = 0;
			}
			for (var i = 0; i < base.length; i++) {
				var l = parseInt(base[i].getAttribute("data-linha"));
				removerLinhas[l] += 1;
			}

			// verificar se tem uma linha completa e mover tudo para baixo

			// console.log(removerLinhas);
		}

		function executarJogo(){
			setTimeout(function () {
				gerarObjeto();
				descerObjeto();
				pintarBase();
				removeLinhas();
				//varificaPerdeu();

				if(!fim){
					executarJogo();
				} else {
					setTimeout(function() {
						alert("Voce perdeu !! Sua pontuacao foi de: " + pontos);
					}, 10);
				}

			}, speed)
		}

		document.onkeyup = function (e) {
			var key = (window.event || e).keyCode;

			if (key == 32){
				if( objeto !== null){objeto.girar();}
			} else if ((key == 37 || key == 65) && !verificaColisao(true, -1)){
				if( objeto !== null){mover(objeto, -1);}
			} else if ((key == 39 || key == 68) && !verificaColisao(true, 1)){
				if( objeto !== null){mover(objeto, +1);}
			} else if (key == 40  && !verificaColisao()){
				if( objeto !== null){descerObjeto();pintarBase();}
			} else if(key == 80){
				fim = true;
			}
		};
		
		criarCampo();
		executarJogo();
//	})();
			
</script>

