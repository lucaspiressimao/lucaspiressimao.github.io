<!DOCTYPE html>
<html>
	<head>
		<style>
			#campoJogo{
			    width: 300px;
			    height: 600px;
			    
			    top: 0;
			    bottom: 0;
			    left: 0;
			    right: 0;
			    margin: auto;
			    outline: 1px solid;
			}
			.campo{
			    width: 30px;
			    height: 30px;
			    
			    float: left;
			}
			.peca{
				box-shadow: 1px 1px;
			}
		</style>
	</head>	
	<body>
		acrescentar outros tipos de pe√ßas <br>
		remover linhas completas<br>
		contar pontos<br>
		verificar fim de jogo <br>
		<div id='campoJogo'></div>
	</body>
</html>
<script type="text/javascript" >
		
	//(function() {
		var linhas = 20;
		var colunas = 10;
		var direcao = 'd'; //c = cima / b = baixo / d = direita / e = esquerda
		var speed = 300;
		var lin = 0
		var col = 0
		var fim = false;
		var pontos = 0;
		var direcaoTemp = 'd';
		var objeto = null;
		var base = [];
		var basePositions = [];
		var colisao = false;
		var max_linhas = false;
		var a_, b_, b_, d_ = null;
		var tipos = {
			't': {
				'sentido': 'b',
				'color': 'red',
				'position':  {
					'a': null,
					'c': null,
					'b': null,
					'd': null
				},
				'limpar': function() {
					this['position'].a.removeAttribute("style");
					this['position'].b.removeAttribute("style");
					this['position'].c.removeAttribute("style");
					this['position'].d.removeAttribute("style");
				},
				'girar': function() {
					this['limpar']();
					var a_col, b_col, c_col, d_col = 0;
					var s = '';
					var a_col = parseInt(this['position'].a.getAttribute("data-coluna"));
					var b_col = parseInt(this['position'].b.getAttribute("data-coluna"));
					var c_col = parseInt(this['position'].c.getAttribute("data-coluna"));
					var d_col = parseInt(this['position'].d.getAttribute("data-coluna"));

					var b_lin = parseInt(this['position'].b.getAttribute("data-linha"));
				
					switch(this['sentido']){
						case 'b':
							b_lin -= 1;
							s = 'e';
							break;
						case 'e':
							b_col += 1;
							s = 'c';
							break;
						case 'c':
							b_lin += 1;
							s = 'd';
							break;
						case 'd':
							b_col -= 1;
							s = 'b';
							break;
					}

					if(b_col < colunas && b_col >= 0 && b_lin < linhas && !verificaColisao()){
							this['sentido'] = s;
							this['position'].c = this['position'].d
							this['position'].d = this['position'].a
							this['position'].a = document.querySelector('[data-linha="' + b_lin + '"][data-coluna="' + b_col + '"]');
					}
					this['pintar']();
				},
				'criar': function() {
					this['sentido'] = 'b';
					this['position'].a = document.querySelector('[data-linha="1"][data-coluna="3"]');
					this['position'].b = document.querySelector('[data-linha="1"][data-coluna="4"]');
					this['position'].c = document.querySelector('[data-linha="1"][data-coluna="5"]');
					this['position'].d = document.querySelector('[data-linha="2"][data-coluna="4"]');

					this['pintar']();
				},
				'pintar': function(){
					this['position'].a.style.backgroundColor = this['color'];
					this['position'].b.style.backgroundColor = this['color'];
					this['position'].c.style.backgroundColor = this['color'];
					this['position'].d.style.backgroundColor = this['color'];
					this['position'].a.style.boxShadow = "inset 0px 0px 2px 2px rgba(0,0,0,0.5)";
					this['position'].b.style.boxShadow = "inset 0px 0px 2px 2px rgba(0,0,0,0.5)";
					this['position'].c.style.boxShadow = "inset 0px 0px 2px 2px rgba(0,0,0,0.5)";
					this['position'].d.style.boxShadow = "inset 0px 0px 2px 2px rgba(0,0,0,0.5)";
				},
				'mover': function(sentido){
					this['limpar']();
					var a_col = parseInt(this['position'].a.getAttribute("data-coluna"));
					var b_col = parseInt(this['position'].b.getAttribute("data-coluna"));
					var c_col = parseInt(this['position'].c.getAttribute("data-coluna"));
					var d_col = parseInt(this['position'].d.getAttribute("data-coluna"));
					
					a_col += sentido;
					b_col += sentido;
					c_col += sentido;
					d_col += sentido;
					
					if( Math.min(a_col, b_col, c_col, d_col) >= 0 && Math.max(a_col, b_col, c_col, d_col) < colunas ){
						this['position'].a = document.querySelector('[data-linha="' + this['position'].a.getAttribute("data-linha") + '"][data-coluna="' + a_col + '"]');
						this['position'].b = document.querySelector('[data-linha="' + this['position'].b.getAttribute("data-linha") + '"][data-coluna="' + b_col + '"]');
						this['position'].c = document.querySelector('[data-linha="' + this['position'].c.getAttribute("data-linha") + '"][data-coluna="' + c_col + '"]');
						this['position'].d = document.querySelector('[data-linha="' + this['position'].d.getAttribute("data-linha") + '"][data-coluna="' + d_col + '"]');
					}
					this['pintar']();
				},
			},
			'l': {
				'sentido': 'b',
				'color': 'blue',
				'position':  {
					'a': null,
					'c': null,
					'b': null,
					'd': null
				},
				'limpar': function() {
					this['position'].a.removeAttribute("style");
					this['position'].b.removeAttribute("style");
					this['position'].c.removeAttribute("style");
					this['position'].d.removeAttribute("style");
				},
				'girar': function() {
					this['limpar']();
					var a_col, b_col, c_col, d_col = 0;
					var s = '';
					var a_col = parseInt(this['position'].a.getAttribute("data-coluna"));
					var b_col = parseInt(this['position'].b.getAttribute("data-coluna"));
					var c_col = parseInt(this['position'].c.getAttribute("data-coluna"));
					var d_col = parseInt(this['position'].d.getAttribute("data-coluna"));

					var b_lin = parseInt(this['position'].b.getAttribute("data-linha"));
				
					switch(this['sentido']){
						case 'b':
							b_lin -= 1;
							s = 'e';
							break;
						case 'e':
							b_col += 1;
							s = 'c';
							break;
						case 'c':
							b_lin += 1;
							s = 'd';
							break;
						case 'd':
							b_col -= 1;
							s = 'b';
							break;
					}

					if(b_col < colunas && b_col >= 0 && b_lin < linhas && !verificaColisao()){
							this['sentido'] = s;
							this['position'].c = this['position'].d
							this['position'].d = this['position'].a
							this['position'].a = document.querySelector('[data-linha="' + b_lin + '"][data-coluna="' + b_col + '"]');
					}
					this['pintar']();
				},
				'criar': function() {
					this['sentido'] = 'b';
					this['position'].a = document.querySelector('[data-linha="1"][data-coluna="3"]');
					this['position'].b = document.querySelector('[data-linha="1"][data-coluna="4"]');
					this['position'].c = document.querySelector('[data-linha="1"][data-coluna="5"]');
					this['position'].d = document.querySelector('[data-linha="2"][data-coluna="4"]');

					this['pintar']();
				},
				'pintar': function(){
					this['position'].a.style.backgroundColor = this['color'];
					this['position'].b.style.backgroundColor = this['color'];
					this['position'].c.style.backgroundColor = this['color'];
					this['position'].d.style.backgroundColor = this['color'];
					this['position'].a.style.boxShadow = "inset 0px 0px 2px 2px rgba(0,0,0,0.5)";
					this['position'].b.style.boxShadow = "inset 0px 0px 2px 2px rgba(0,0,0,0.5)";
					this['position'].c.style.boxShadow = "inset 0px 0px 2px 2px rgba(0,0,0,0.5)";
					this['position'].d.style.boxShadow = "inset 0px 0px 2px 2px rgba(0,0,0,0.5)";
				},
				'mover': function(sentido){
					this['limpar']();
					var a_col = parseInt(this['position'].a.getAttribute("data-coluna"));
					var b_col = parseInt(this['position'].b.getAttribute("data-coluna"));
					var c_col = parseInt(this['position'].c.getAttribute("data-coluna"));
					var d_col = parseInt(this['position'].d.getAttribute("data-coluna"));
					
					a_col += sentido;
					b_col += sentido;
					c_col += sentido;
					d_col += sentido;
					
					if( Math.min(a_col, b_col, c_col, d_col) >= 0 && Math.max(a_col, b_col, c_col, d_col) < colunas ){
						this['position'].a = document.querySelector('[data-linha="' + this['position'].a.getAttribute("data-linha") + '"][data-coluna="' + a_col + '"]');
						this['position'].b = document.querySelector('[data-linha="' + this['position'].b.getAttribute("data-linha") + '"][data-coluna="' + b_col + '"]');
						this['position'].c = document.querySelector('[data-linha="' + this['position'].c.getAttribute("data-linha") + '"][data-coluna="' + c_col + '"]');
						this['position'].d = document.querySelector('[data-linha="' + this['position'].d.getAttribute("data-linha") + '"][data-coluna="' + d_col + '"]');
					}
					this['pintar']();
				},
			}
		};

		function criarCampo(){
			for (i = 0; i < linhas; i++) { 
				var divLinha = document.createElement('div');
				divLinha.setAttribute('id', 'linha' + i);
				document.getElementById("campoJogo").appendChild(divLinha);
				for (j = 0; j < colunas; j++) { 
					var div = document.createElement('div');
					div.className = 'campo';
					div.setAttribute('data-linha', i);
					div.setAttribute('data-coluna', j);
					document.getElementById("linha"+i).appendChild(div);
				}
			}
		}

		function gerarObjeto(){
			if(objeto == null){
				var numeroSorte = (Math.floor((Math.random() * 10)) % (Object.values(tipos).length) );
				objeto = Object.values(tipos)[numeroSorte];
				objeto.criar();
			}
		}

		function verificaColisao(lateral=false, direcao=0, descer=1){
			colisao = false;
			if( objeto !== null){
				var a_lin = parseInt(objeto.position.a.getAttribute("data-linha"));
				var b_lin = parseInt(objeto.position.b.getAttribute("data-linha"));
				var c_lin = parseInt(objeto.position.c.getAttribute("data-linha"));
				var d_lin = parseInt(objeto.position.d.getAttribute("data-linha"));
				
				var a_col = parseInt(objeto.position.a.getAttribute("data-coluna"));
				var b_col = parseInt(objeto.position.b.getAttribute("data-coluna"));
				var c_col = parseInt(objeto.position.c.getAttribute("data-coluna"));
				var d_col = parseInt(objeto.position.d.getAttribute("data-coluna"));
		
				if(lateral)
					descer = 0;
			
				a_ = document.querySelector('[data-linha="' + (a_lin + descer) + '"][data-coluna="' + (a_col + direcao) + '"]');
				b_ = document.querySelector('[data-linha="' + (b_lin + descer) + '"][data-coluna="' + (b_col + direcao) + '"]');
				c_ = document.querySelector('[data-linha="' + (c_lin + descer) + '"][data-coluna="' + (c_col + direcao) + '"]');
				d_ = document.querySelector('[data-linha="' + (d_lin + descer) + '"][data-coluna="' + (d_col + direcao) + '"]');
				
				for (var i = 0; i < basePositions.length; i++) {
					if(	basePositions[i].isEqualNode(a_) ||
						basePositions[i].isEqualNode(b_) ||
						basePositions[i].isEqualNode(c_) ||
						basePositions[i].isEqualNode(d_)){
						colisao = true;
						break;
					}
				}

				max_linhas = (Math.max(a_lin, b_lin, c_lin, d_lin) +1) < linhas
				return colisao;
			}
		}

		function descerObjeto(){
			if( objeto !== null){
				objeto.limpar();
				verificaColisao();

				if( max_linhas && !colisao){
					objeto.position.a = a_;
					objeto.position.b = b_;
					objeto.position.c = c_;
					objeto.position.d = d_;
					objeto.pintar();
				} else {	
					atualizarBase();
				}	
			}
		}

		function pintarBase(){
			for (var i = 0; i < base.length; i++) {
				base[i].pintar();
			}
		}

		function atualizarBase(){
			base.push(objeto);
			basePositions.push(objeto.position.a);
			basePositions.push(objeto.position.b);
			basePositions.push(objeto.position.c);
			basePositions.push(objeto.position.d);
			objeto = null;
		}

		function executarJogo(){
			setTimeout(function () {
				gerarObjeto();
				//removeLinhas(+pontos);
				descerObjeto();
				pintarBase();
				//varificaPerdeu();

				if(!fim){
					executarJogo();
				} else {
					setTimeout(function() {
						alert("Voce perdeu !! Sua pontuacao foi de: " + pontos);
					}, 10);
				}

			}, speed)
		}

		document.onkeyup = function (e) {
			var key = (window.event || e).keyCode;
			
			if (key == 32){
				if( objeto !== null){objeto.girar();}
			} else if ((key == 37 || key == 65) && !verificaColisao(true, -1)){
				if( objeto !== null){objeto.mover(-1);}
			} else if ((key == 39 || key == 68) && !verificaColisao(true, 1)){
				if( objeto !== null){objeto.mover(+1);}
			} else if (key == 40  && !verificaColisao()){
				if( objeto !== null){descerObjeto();pintarBase();}
			}
		};
		
		criarCampo();
		executarJogo();
//	})();
			
</script>

